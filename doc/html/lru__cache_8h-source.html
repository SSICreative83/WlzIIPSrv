<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>iipsrv: lru_cache.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">src</a></div>
<h1>lru_cache.h</h1><div class="fragment"><pre class="fragment">00001 <span class="comment">/***************************************************************************</span>
00002 <span class="comment">*   Copyright (C) 2004 by Patrick Audley                                  *</span>
00003 <span class="comment">*   paudley@blackcat.ca                                                   *</span>
00004 <span class="comment">*                                                                         *</span>
00005 <span class="comment">***************************************************************************/</span>
00016 <span class="preprocessor">#include &lt;map&gt;</span>
00017 <span class="preprocessor">#include &lt;list&gt;</span>
00018 <span class="preprocessor">#ifdef _REENTRANT</span>
00019 <span class="preprocessor"></span><span class="preprocessor">#include &lt;boost/thread/mutex.hpp&gt;</span>
00021 <span class="preprocessor">#define SCOPED_MUTEX  boost::mutex::scoped_lock lock(this-&gt;_mutex);</span>
00022 <span class="preprocessor"></span><span class="preprocessor">#else</span>
00023 <span class="preprocessor"></span>
00024 <span class="preprocessor">#define SCOPED_MUTEX</span>
00025 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00026 <span class="preprocessor"></span>
<a name="l00037"></a><a class="code" href="classLRUCache.html">00037</a> <span class="keyword">template</span>&lt;<span class="keyword">class</span> Key,<span class="keyword">class</span> Data&gt; <span class="keyword">class </span><a class="code" href="classLRUCache.html">LRUCache</a> {
00038         <span class="keyword">public</span>:
<a name="l00040"></a><a class="code" href="classLRUCache.html#w0">00040</a>                 <span class="keyword">typedef</span> std::list&lt; std::pair&lt; Key, Data &gt; &gt; List;
<a name="l00042"></a><a class="code" href="classLRUCache.html#w1">00042</a>                 <span class="keyword">typedef</span> <span class="keyword">typename</span> List::iterator List_Iter;
<a name="l00044"></a><a class="code" href="classLRUCache.html#w2">00044</a>                 <span class="keyword">typedef</span> std::map&lt; Key, List_Iter &gt; Map;
<a name="l00046"></a><a class="code" href="classLRUCache.html#w3">00046</a>                 <span class="keyword">typedef</span> <span class="keyword">typename</span> Map::iterator Map_Iter;
00047 
<a name="l00049"></a><a class="code" href="classLRUCache.html#w6">00049</a>                 <span class="keyword">enum</span> deletion_strategies {
00050                         IGNORE,                                         
00051                         DELETE,                                         
00052                 };
00053 
00054         <span class="keyword">private</span>:
00056                 List _list;
00058                 Map _index;
00059 
00061                 <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> _max_size;
00062 
00064                 deletion_strategies _deletion_strategy;
00065 
00066 <span class="preprocessor">#ifdef _REENTRANT</span>
00067 <span class="preprocessor"></span>                boost::mutex _mutex;
00068 <span class="preprocessor">#endif</span>
00069 <span class="preprocessor"></span>
00070         <span class="keyword">public</span>:
<a name="l00075"></a><a class="code" href="classLRUCache.html#a0">00075</a>                 <a class="code" href="classLRUCache.html">LRUCache</a>( <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> Size, <span class="keyword">const</span> deletion_strategies DeletionStrategy = IGNORE ) :
00076                                 _max_size( Size ),
00077                                 _deletion_strategy( DeletionStrategy )
00078                                 {}
<a name="l00080"></a><a class="code" href="classLRUCache.html#a1">00080</a>                 ~<a class="code" href="classLRUCache.html">LRUCache</a>() { this-&gt;clear(); }
00081 
<a name="l00085"></a><a class="code" href="classLRUCache.html#a2">00085</a>                 <span class="keyword">inline</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> size( <span class="keywordtype">void</span> )<span class="keyword"> const </span>{ <span class="keywordflow">return</span> _list.size(); }
00086 
<a name="l00090"></a><a class="code" href="classLRUCache.html#a3">00090</a>                 <span class="keyword">inline</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> max_size( <span class="keywordtype">void</span> )<span class="keyword"> const </span>{ <span class="keywordflow">return</span> _max_size; }
00091 
<a name="l00093"></a><a class="code" href="classLRUCache.html#a4">00093</a>                 <span class="keywordtype">void</span> clear( <span class="keywordtype">void</span> ) {
00094                         SCOPED_MUTEX;
00095                         _list.clear();
00096                         _index.clear();
00097                 };
00098 
<a name="l00103"></a><a class="code" href="classLRUCache.html#a5">00103</a>                 <span class="keyword">inline</span> <span class="keywordtype">bool</span> exists( <span class="keyword">const</span> Key &amp;key )<span class="keyword"> const </span>{
00104                         <span class="keywordflow">return</span> _index.find( key ) != _index.end();
00105                 }
00106 
<a name="l00110"></a><a class="code" href="classLRUCache.html#a6">00110</a>                 <span class="keyword">inline</span> <span class="keywordtype">void</span> remove( <span class="keyword">const</span> Key &amp;key ) {
00111                         SCOPED_MUTEX;
00112                         Map_Iter miter = _index.find( key );
00113                         <span class="keywordflow">if</span>( miter == _index.end() ) <span class="keywordflow">return</span>;
00114                         this-&gt;_remove( miter );
00115                 }
00116 
<a name="l00120"></a><a class="code" href="classLRUCache.html#a7">00120</a>                 <span class="keyword">inline</span> <span class="keywordtype">void</span> touch( <span class="keyword">const</span> Key &amp;key ) {
00121                         SCOPED_MUTEX;
00122                         <span class="comment">// Find the key in the index.</span>
00123                         Map_Iter miter = this-&gt;_touch( key );
00124                 }
00125 
<a name="l00131"></a><a class="code" href="classLRUCache.html#a8">00131</a>                 <span class="keyword">inline</span> Data *fetch( <span class="keyword">const</span> Key &amp;key, <span class="keywordtype">bool</span> touch = <span class="keyword">true</span> ) {
00132                         Map_Iter miter = _index.find( key );
00133                         <span class="keywordflow">if</span>( miter == _index.end() ) <span class="keywordflow">return</span> NULL;
00134                         this-&gt;touch( key );
00135                         <span class="keywordflow">return</span> &amp;(miter-&gt;second-&gt;second);
00136                 }
00137 
<a name="l00143"></a><a class="code" href="classLRUCache.html#a9">00143</a>                 <span class="keyword">inline</span> <span class="keywordtype">void</span> insert( <span class="keyword">const</span> Key &amp;key, <span class="keyword">const</span> Data &amp;data ) {
00144                         SCOPED_MUTEX;
00145                         <span class="comment">// Touch the key, if it exists, then replace the content.</span>
00146                         Map_Iter miter = this-&gt;_touch( key );
00147                         <span class="keywordflow">if</span>( miter != _index.end() ) {
00148                                 this-&gt;_remove( miter );
00149                         }
00150                         <span class="comment">// Ok, do the actual insert at the head of the list</span>
00151                         _list.push_front(std::make_pair(key,data));
00152                         List_Iter liter = _list.begin();
00153                         <span class="comment">// Store the index</span>
00154                         _index[ key ] = liter;
00155                         <span class="comment">// Check to see if we need to remove an element due to exceeding max_size</span>
00156                         <span class="keywordflow">if</span>( _list.size() &gt; _max_size ) {
00157                                 <span class="comment">// Remove the last element.</span>
00158                                 liter = _list.end();
00159                                 --liter;
00160                                 this-&gt;_remove( liter-&gt;first );
00161                         }
00162                 }
00163 
00164 <span class="preprocessor">#ifdef DEBUG</span>
00165 <span class="preprocessor"></span>
00168                  List *debug_get_list_pointer( <span class="keywordtype">void</span> ) { <span class="keywordflow">return</span> &amp;_list; }
00169 <span class="preprocessor">#endif</span>
00170 <span class="preprocessor"></span>
00171         <span class="keyword">private</span>:
00176                 <span class="keyword">inline</span> Map_Iter _touch( <span class="keyword">const</span> Key &amp;key ) {
00177                         Map_Iter miter = _index.find( key );
00178                         <span class="keywordflow">if</span>( miter == _index.end() ) <span class="keywordflow">return</span> miter;
00179                         <span class="comment">// Move the found node to the head of the list.</span>
00180                         _list.splice( _list.begin(), _list, miter-&gt;second );
00181                         <span class="keywordflow">return</span> miter;
00182                 }
00183 
00188                 <span class="keyword">inline</span> <span class="keywordtype">void</span> _remove( <span class="keyword">const</span> Map_Iter &amp;miter ) {
00189                         _list.erase( miter-&gt;second );
00190                         _index.erase( miter );
00191                 }
00192 
00196                 <span class="keyword">inline</span> <span class="keywordtype">void</span> _remove( <span class="keyword">const</span> Key &amp;key ) {
00197                         Map_Iter miter = _index.find( key );
00198                         _list.erase( miter-&gt;second );
00199                         _index.erase( miter );
00200                 }
00201 };
00202 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Fri Apr 1 16:56:57 2005 for iipsrv by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
